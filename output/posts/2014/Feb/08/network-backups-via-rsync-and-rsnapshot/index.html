<!DOCTYPE html>         <!-- This is the HTML5 doctype -->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Network Backups via Rsync and Rsnapshot - Jeff's Skinner Box</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="../../../../../favicon.ico" rel="icon">

    <!-- Open Graph tags -->
            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Network Backups via Rsync and Rsnapshot"/>
            <meta property="og:url" content="../../../../../posts/2014/Feb/08/network-backups-via-rsync-and-rsnapshot/"/>
            <meta property="og:description" content="Using a external hard drive, and rsync / rsnapshot as a remote filesystem backup utility, I create scheduled incremental backups of my Linux & Windows file systems. This light-weight and efficient scheme allows me to create increment backups every 4 hours and keep backups up to three months."/>

    <!-- Bootstrap -->
        <link href="../../../../../theme/css/bootstrap.flatly.min.css" rel="stylesheet" type="text/css"/>

    <!-- Font Awesome and Google Fonts -->
    <link href="../../../../../theme/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Knewave' rel='stylesheet' type='text/css'>

    <link href="../../../../../theme/css/pygments/default.css" rel="stylesheet">
    <link href="../../../../../theme/css/style.css" rel="stylesheet" type="text/css"/>
        <link href="../../../../../static/custom.css" rel="stylesheet">

</head>

<body>
<div class="navbar navbar-default navbar-fixed-top" role="navigation" style="box-shadow: 5px 5px 10px #888888;">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../../../../../" style="font-family: Knewave, cursive; font-size: 48px; color: #FFFFFF">
Jeff's Skinner Box&nbsp;            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/pages/about-me/">About Me</a></li>
                    <li><a href="http://127.0.0.1:8080">MicroContent</a></li>
                    <li><a href="/pages/open-notebook/">Open Notebook</a></li>
            </ul>
            <ul class="nav navbar-nav">
                <li><a href="../../../../../archives.html">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
  <!-- GitHub Ribbon - https://github.com/blog/273-github-ribbons -->
<!-- GitHub Ribbon - https://github.com/blog/273-github-ribbons -->
    <a href="https://github.com/jeffskinnerbox/jeffskinnerbox.github.io/tree/source" target="_blank">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github-camo.global.ssl.fastly.net/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png">
    </a>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../../../../../posts/2014/Feb/08/network-backups-via-rsync-and-rsnapshot/"
                       rel="bookmark"
                       title="Permalink to Network Backups via Rsync and Rsnapshot">
                        Network Backups via Rsync and Rsnapshot
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-02-08T00:01:00-05:00"> Saturday&nbsp;&nbsp;&nbsp;&nbsp;February 08, 2014</time>
    </span>



&nbsp;&nbsp;&nbsp;
<i class="fa fa-tags fa-lg"></i>
    <a class="btn btn-default btn-xs" href="../../../../../tag/linux/">Linux</a>
        &nbsp;
    <a class="btn btn-default btn-xs" href="../../../../../tag/rsync/">Rsync</a>
        &nbsp;
    <a class="btn btn-default btn-xs" href="../../../../../tag/rsnapshot/">Rsnapshot</a>
        &nbsp;
    <a class="btn btn-default btn-xs" href="../../../../../tag/backup/">Backup</a>
        &nbsp;
    <a class="btn btn-default btn-xs" href="../../../../../tag/cygwin/">Cygwin</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <h2>Rsync and Rsnapshot</h2>
<p><a href="http://thewirecutter.com/reviews/the-best-external-desktop-hard-drive/">
<img class="img-rounded floatLeft" style="margin: 0px 8px; float: left" title="Seagate Backup Plus" alt="{{ site.author.name }}" src="/images/seagate-backup-plus-4-tb.jpg" width="30%" height="30%" /></a>
I got a 4 Terabyte <a href="http://www.seagate.com/external-hard-drives/desktop-hard-drives/backup-plus-desk/">Seagate Backup Plus</a> hard drive as a Christmas present and
I plan to put it to use as a central backup for my Linux desktop, multiple Raspberry Pi,
my laptop, and anything else that my come along.
My plan is to keep things simple but I wish to do
regular hourly, daily, weekly, and monthly incremental backups.
This will give me the ability to recover files from the past,
but also to recover from a hardware failure or software install that has gone very badly.</p>
<p>There are <a href="http://www.techrepublic.com/blog/10-things/10-outstanding-linux-backup-utilities/">many backup tools</a> you can pick from but
I wanted to stick with something basic, widely used, and simple.
<a href="http://rsync.samba.org/">Rsync</a> is one of the most widely used Linux backup solutions, and in fact,
it is often used by <a href="http://en.wikipedia.org/wiki/Rsync">other backup tools</a> as a foundational component.
Rsync stands for <strong>r</strong>emote <strong>sync</strong>hronization tool.
Rsync is a UN*X command line utility, containing a <a href="http://wiki.r1soft.com/display/TP/rsync+Backup">special protocol and algorithm</a>,
that synchronizes files and directories from one location to another
while minimizing data transfer by using fast incremental file transfers.
(rsync has also been ported to Microsoft Windows, Mac, and other operating systems.)
The first time, rsync sends all the data over the network to your backup machine.
The benefit comes the next time you backup.
Instead of sending all the files again, rsync only transfers files that have been changed.
If no files were changed, no files get transferred.
And when you want to recover data, you transfer just the specific files that you want back to your machine
(using rsync or scp or telnet or whatever).</p>
<p>It creates a full-blown snapshot for each run,
but makes extensive use of <a href="http://www.linfo.org/hard_link.html">hard links</a><sup id="fnref:A"><a class="footnote-ref" href="#fn:A" rel="footnote">1</a></sup> for files that haven’t changed,
thereby greatly reduce the disk space required.
That means you get efficient, lightweight,
incremental backups that look like exactly like full-blown copies (in every way).
This makes Rsnapshot a great choice for server backups.
This easy-to-use utility is commonly used for backing up data,
but can synchronize files for any other purpose you choose to use it for.
Remote sync can be better than other backup methods because of its speed,
and because it doesn’t require any special permissions to execute an rsync command.
With just a small knowledge of the command line, you can be backing up in no time with rsync.
You can also use <a href="http://en.wikipedia.org/wiki/Cron">cron</a> to periodically create backups.
To top it off, it also has a graphics front-end tool, call <a href="http://www.opbyte.it/grsync/">grsync</a>,
and <a href="http://www.rsnapshot.org/">rsnapshot</a> to create scheduled incremental backups, if so desired.</p>
<h2>Install the Hard Drive</h2>
<p>The physical install of the external <a href="http://www.seagate.com/external-hard-drives/desktop-hard-drives/backup-plus-desk/">Seagate Backup Plus</a> drive was simple, just plug it in.
The only caveat is to use a <a href="http://en.wikipedia.org/wiki/USB_3.0">USB 3.0</a> port on the Linux box to make sure you
get the fill speed out of the drive.
Using the supplied USB 3.0 cable is a must,
since a USB 2.0 cable will force the drive to operate at a slower speed.
Check out <a href="http://www.diffen.com/difference/USB_2.0_vs_USB_3.0">USB 2.0 vs USB 3.0</a> to understand further.</p>
<p>Under my Ubuntu system, this external disk's file system will be automatically mounted
located at <code>/media/jeff/"Seagate Backup Plus Drive"</code>.
This nice and easy, but the disk is formated as a <a href="http://en.wikipedia.org/wiki/NTFS">NTFS (New Technology File System)</a>
which is a proprietary file system developed by Microsoft.
For Linux compatibility reasons,
I want the disk to support a <a href="https://help.ubuntu.com/community/LinuxFilesystemsExplained">Linux ext3 file system</a>.
This will requiring re-formating and mounting the new disk.
To do this, I followed the procedures outlined in
in the article "<a href="http://www.itechlounge.net/2012/01/linux-partition-and-format-external-hard-drive-as-ext3-filesystem/">Partition and format external hard drive as ext3 filesystem</a>".
I created a mount point called <code>/mnt/backup</code> for the hard drive and
place it in the <code>fstab</code> file so its mounted every time at boot up.</p>
<h2>Install rsync, grsync, and rsnapshot</h2>
<p>Rsync should already be installed on most Linux system.
You can install it, and the <a href="http://www.opbyte.it/grsync/">grsync</a> &amp; <a href="http://www.rsnapshot.org/">rsnapshot</a> tools, using this command:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo apt-get install rsync grsync rsnapshot
</pre></div>


<h2>Select Backup Storage Location</h2>
<p>I want to create directory for the backups that are readable by all users, but writable by only root.
To do this, do the following:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>mkdir /mnt/backup
chmod a+rwx /mnt/backup
chmod o-w /mnt/backup
</pre></div>


<h2>Getting Familiar with rsync and Preparatory Work</h2>
<p>In this section, we'll learn about some of rsync's features and get some foundational stuff done.</p>
<h3>Dry Running a rsync Command</h3>
<p>Rsync has the potential of really messing up things
and then doing an undo can be a tedious job.
Rsync can be run in a "dry run" mode to show you the output of the command.
For example, this will make a copy of <code>~/tmp</code>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>rsync -azv --dry-run /home/jeff/tmp/ /home/jeff/tmp/copy-of-tmp
</pre></div>


<p>If the output shows exactly what you want to do,
then you can remove <code>–dry-run</code> option from your command and re-run it for real.</p>
<h3>Test rsync on Local System</h3>
<p>In an effort to try out rsync in the raw,
I'll create some ad hoc backups of my desktop's home directory.
I want to preserves file timestamp, symbolic links, permissions, and owner/group.
This can be done using the rsync option <code>-a</code>.
Additional options used are <code>-z</code> to enable compression,
and <code>-v</code> to provide verbose status output.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv /home/jeff/src/rtl-sdr/ /mnt/backup/rsync-test1
</pre></div>


<p>The <code>sudo</code> is required since I have made <code>/mnt/backup</code> writable only by root.
The presence or absence of the terminating <code>/</code> within the rsync command line is important.
The following two commands produce different results:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv /home/jeff/Documents/<span style="color: #CC3300">&quot;My Maps&quot;</span>/ /mnt/backup/rsync-test2
sudo rsync -azv /home/jeff/Documents/<span style="color: #CC3300">&quot;My Maps&quot;</span> /mnt/backup/rsync-test3
</pre></div>


<p>The first takes the sources files and subdirectories and writes them directly to the destination directory.
The second does the same but the files and directories go within a directory called <code>My Maps</code>.
This is an important subtlety to remember!</p>
<h3>Testing rsync on a Remote System</h3>
<p>In this case, my Linux desktop machine is the local system and RPi is the remote machine.
The Linux desktop has the external drive used for backups.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv pi@RedRPi:/home/pi/src/nRF24L01 /mnt/backup/rsync-test4
</pre></div>


<p>This will first prompt you for a password for the <code>sudo</code>.
You will get a subsequent prompt for the login as <code>pi</code> on the <code>RedRPi</code> system,
and then the data will be transfered to the external drive.
But when performing beyond your the firewall, you should use ssh<sup id="fnref:A1"><a class="footnote-ref" href="#fn:A1" rel="footnote">2</a></sup>, as shown below:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh pi@RedRPi:/home/pi/src/ /mnt/backup/rsync-test5
</pre></div>


<p>To setup ssh with rsync so that it can run automatically without prompting for the password,
checkout "<a href="http://www.thegeekstuff.com/2011/07/rsync-over-ssh-without-password/">How to Setup Rsync with SSH on UNIX / Linux (rsync without password)</a>".
This is sometime you will want to do to support automatic, unattended backups.
Basically, your going to do the following on the machine that will store the backups<sup id="fnref:B"><a class="footnote-ref" href="#fn:B" rel="footnote">3</a></sup>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #336666">cd</span> <span style="color: #003333">$HOME</span>
mkdir .ssh
chmod <span style="color: #FF6600">755</span> .ssh
ssh-keygen -N <span style="color: #CC3300">&quot;&quot;</span> -f /<span style="color: #003333">$HOME</span>/.ssh/id_rsa
ssh-copy-id -i /<span style="color: #003333">$HOME</span>/.ssh/id_rsa.pub pi@RedRPi
ssh-copy-id -i /<span style="color: #003333">$HOME</span>/.ssh/id_rsa.pub pi@BlackRPi
sudo bash
<span style="color: #336666">cd</span> /root
mkdir .ssh
chmod <span style="color: #FF6600">755</span> .ssh
ssh-keygen -N <span style="color: #CC3300">&quot;&quot;</span> -f /root/.ssh/id_rsa
ssh-copy-id -i /root/.ssh/id_rsa.pub pi@RedRPi
ssh-copy-id -i /root/.ssh/id_rsa.pub pi@BlackRPi
<span style="color: #336666">exit</span>
</pre></div>


<p>Now repeat the example above:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh pi@RedRPi:/home/pi/src/ /mnt/backup/rsync-test5a
</pre></div>


<p>You should no longer be promoted for a password, except by the first <code>sudo</code>.
(Once rsync is run under a root login, this <code>sudo</code> will no longer be required).</p>
<h3>Exclude Files / Directories from rsync</h3>
<p>In a typical backup situation,
you might want to exclude one or more files (or directories) from the backup.
You might also want to exclude a specific file type from rsync.
Let's run a backup of <code>pi@RedRPi:/home/pi/</code>
but leave out the <code>tmp</code> and <code>src</code> directories.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh --exclude <span style="color: #CC3300">&#39;tmp&#39;</span> --exclude <span style="color: #CC3300">&#39;src&#39;</span> pi@RedRPi:/home/pi/ /mnt/backup/rsync-test6
</pre></div>


<p>You could also create a file that contains the exclude list <code>tmp</code> and <code>src</code>.
This would look like:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv --exclude-from <span style="color: #CC3300">&#39;exclude-list.txt&#39;</span> pi@RedRPi:/home/pi/ /mnt/backup/rsync-test6
</pre></div>


<h3>Running rsync as Root</h3>
<p>The above examples works fine as long as the source login (in this case <code>pi</code> on the <code>RedRPi</code> system)
has the appropriate permissions.
For example, this will fail:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh  pi@RedRPi:/root/ /mnt/backup/rsync-test7
</pre></div>


<p>It fails because the user <code>pi</code> doesn't have <code>root</code> permissions
and the directory <code>/root/</code> can only be entered by the user <code>root</code>.
You might want to attempt to do the following:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh root@RedRPi:/root/ /mnt/backup/rsync-test7
</pre></div>


<p>Now your asking to login to the remote system as user root.
In this case you'll be prompted to provide the RedRPi's root password,
but the root login may not have a password<sup id="fnref:C"><a class="footnote-ref" href="#fn:C" rel="footnote">4</a></sup>.</p>
<p>The way around all this is to use the <code>--rsync-path</code> option for rsync.
This will work:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh --rsync-path<span style="color: #555555">=</span><span style="color: #CC3300">&quot;sudo rsync&quot;</span> pi@RedRPi:/root /mnt/backup/rsync-test7
</pre></div>


<p>The <code>--rsync-path</code> parameter specifies a path to rsync on the remote machine.
So <code>rsync</code> will be executed using <code>sudo</code>, giving it root user access privileges,
and now the use of the <code>pi</code> login will gain access to the <code>/root</code> directory.
That is, on the remote machine, rsync is being run as root!
This all requires the proper set-up of ssh with password-less access, discussed earlier.</p>
<h3>Configuration of ssh to Eliminate Password Prompt and Warning Messages</h3>
<p>Proper configuration of ssh will be needed to assure routine warning messages<sup id="fnref:D"><a class="footnote-ref" href="#fn:D" rel="footnote">5</a></sup>
don't disrupt the smooth operation of rsync / rsnapshot.</p>
<p>With the SSH protocol,
it is the SSH client's responsibility to verify the identity
of the host to which it is connecting.
The host identify is established by its SSH host key.
Typically, the host key is auto-created during initial SSH installation setup.</p>
<p>SSH protocol is designed to verify the host key against a local file
(that file being <code>~/.ssh/known_hosts</code>)
to ensure the integrity of the remote server.
By default, the user is prompted to accept a new key or warned when the host key changes
(like after a server upgrade,
DHCP server has given that IP address to a different machine from the one that had it last time).
This is a nice defense against
<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">Man-In-The-Middle attacks</a>,
but it plays havoc on scripts.
If a prompt occurs, your script stops and waits for input.</p>
<p>There are two ways we can eliminate this.
One is at the script level and the other is at the system level.
If we want to continue to prompt for host key checks,
then we can add the configuration to our script.
This can be done with OpenSSH’s <code>-o</code> option.
Here’s an example in which we run the hostname command on a remote server:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>ssh -o <span style="color: #003333">StrictHostKeyChecking</span><span style="color: #555555">=</span>no <span style="color: #CC3300; font-weight: bold">\</span>
    -o <span style="color: #003333">UserKnownHostsFile</span><span style="color: #555555">=</span>/dev/null <span style="color: #CC3300; font-weight: bold">\</span>
    -q user@host /usr/bin/hostname -s
</pre></div>


<p>To set this configuration system-wide,
place these entries in <code>ssh_config</code>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>StrictHostKeyChecking no
UserKnownHostsFile /dev/null
LogLevel QUIET
</pre></div>


<p>For our backup utility, we need to add the appropriate parameters to one of the
<code>ssh</code> configuration files listed below:</p>
<ul>
<li><strong>System-wide SSH client configuration files (i.e. /etc/ssh/ssh_config -</strong> This files set the default configuration for all users of OpenSSH clients on that desktop/laptop and it must be readable by all users on the system.</li>
<li><strong>User-specific SSH client configuration files (i.e. $HOME/.ssh/config -</strong> This is user's own configuration file which, overrides the settings in the global client configuration file, <code>/etc/ssh/ssh_config</code>.</li>
</ul>
<p>Add this to <code>/etc/ssh/ssh_conf</code> file to disable the host key checking
and the warnings<sup id="fnref:E"><a class="footnote-ref" href="#fn:E" rel="footnote">6</a></sup> for all users who access systems who's names end in 'RPi'.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>Host *RPi
    StrictHostKeyChecking no
    UserKnownHostsFile=/dev/null
</pre></div>


<p>In addition, add the following to the <code>$HOME/.ssh/config</code> file:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>UserKnownHostsFile  ~/.ssh/known_hosts
</pre></div>


<p>Make these changes active by restarting the ssh services via the command <code>sudo service ssh restart</code>.</p>
<p>With ssh properly configured, a command like</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsync -azv -e ssh --rsync-path<span style="color: #555555">=</span><span style="color: #CC3300">&quot;sudo rsync&quot;</span> pi@BlackRPi:/root/.rpi-firmware/ /mnt/backup/rsync-test8
</pre></div>


<p>This should run without requesting passwords, it will run on the remote as the root user,
and warning messages about differing "ECDSA host key" should not get in your way.
It will run without user intervention; just what we need for automated backups!</p>
<h3>Creating Backup Users on Remote Servers</h3>
<p>On all the remote systems (i.e. RedRPi and BlackRPi) you need to create the login
and establish its ssh authentication keys.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo adduser backup_user --disabled-password -u 400
sudo mkdir /home/backup_user/.ssh
sudo chmod <span style="color: #FF6600">700</span> /home/backup_user/.ssh
</pre></div>


<p>Now create a rsync wrapper script:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo mkdir /home/backup_user/bin
sudo vim /home/backup_user/bin/rsync-wrapper.sh
</pre></div>


<p>Enter the following in this file to create the script:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/bin/bash</span>

<span style="color: #0099FF; font-style: italic"># This script is a wrapper around rsync, so that rsync can run as root,</span>
<span style="color: #0099FF; font-style: italic"># and at the same time, eliminate any security risks.</span>

<span style="color: #0099FF; font-style: italic"># Location of the Log file</span>
<span style="color: #003333">LOG</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/home/backup_user/backup.log&quot;</span>

<span style="color: #0099FF; font-style: italic"># Place in the log file information concerning the execution of this script</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;rsync wrapper script executed on `date`&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;options passed to rsync: &quot;</span> <span style="color: #003333">$@</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;---------------------------------------------&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>

<span style="color: #0099FF; font-style: italic"># Now execute the script</span>
/usr/bin/sudo /usr/bin/rsync <span style="color: #003333">$@</span>
</pre></div>


<p>Now change the mode and owner of this file:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo chown backup_user:backup_user /home/backup_user/*
sudo chown backup_user:backup_user /home/backup_user/bin/rsync-wrapper.sh
sudo chmod <span style="color: #FF6600">754</span> /home/backup_user/bin/rsync-wrapper.sh
</pre></div>


<p><code>backup_user</code> is not root, and therefore, <code>rsync</code>
can't freely move through the whole directory system , write files, and such.
Linux does provide a way to give a user limited super-user privileges.
To do this for the <code>backup_user</code>, configure <code>sudo</code>
such that it can run the <code>rsync</code>tool
as root without being being prompted for a password.
For security reasons, we what only the these tools to have <code>sudo</code> privileges.
Using <a href="http://www.sudo.ws/sudo/sudoers.man.html"><code>visudo</code></a> command, edit the <a href="http://www.sudo.ws/visudo.man.html"><code>/etc/sudoers</code></a><sup id="fnref:F"><a class="footnote-ref" href="#fn:F" rel="footnote">7</a></sup> file by adding the following
to the bottom of the file.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic"># allows this user to not need a password to sudo the specified command(s)</span>
backup_user    <span style="color: #003333">ALL</span><span style="color: #555555">=</span>NOPASSWD:    /usr/bin/rsync
</pre></div>


<h3>Creating Backup Users for Backup Server</h3>
<p>On the host server (i.e. desktop) you need to create the login
(with a UID of less that 500<sup id="fnref:G"><a class="footnote-ref" href="#fn:G" rel="footnote">8</a></sup>)
which will run the rsync / rsnapshot utilities
and establish its <code>ssh</code> authentication keys.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo adduser backup_user -u 400
sudo chown backup_user:backup_user /home/backup_user/*
sudo su backup_user
<span style="color: #336666">cd</span> ~
ssh-keygen -N <span style="color: #CC3300">&quot;&quot;</span> -f ~/.ssh/id_rsa
ssh-copy-id -i ~/.ssh/id_rsa.pub backup_user@RedRPi
ssh-copy-id -i ~/.ssh/id_rsa.pub backup_user@BlackRPi
<span style="color: #336666">exit</span>
</pre></div>


<p>And just like the remote systems <code>backup_user</code> is not root,
and therefore, the utilities it uses
(<code>rsync</code> and <code>rsnapshot</code>)
can't freely move through the whole directory system , write files, and such.
Again using the <a href="http://www.sudo.ws/sudo/sudoers.man.html"><code>visudo</code></a> command,
edit the <a href="http://www.sudo.ws/visudo.man.html"><code>/etc/sudoers</code></a> file by adding the following
to the bottom of the file.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic"># allows this user to not need a password to sudo the specified command(s)</span>
backup_user    <span style="color: #003333">ALL</span><span style="color: #555555">=</span>NOPASSWD:    /usr/bin/rsync
backup_user    <span style="color: #003333">ALL</span><span style="color: #555555">=</span>NOPASSWD:    /usr/bin/rsnapshot
</pre></div>


<h2>Configuring rsnapshot for Incremental Backups</h2>
<p>Our mission here is to use rsnapshot to create backups of both normal
and protected/restricted files from one server to another over <code>ssh</code>
without enabling remote root access to either server while
maintaining original file attributes and permissions<sup id="fnref:H"><a class="footnote-ref" href="#fn:H" rel="footnote">9</a></sup>.</p>
<p>Where rsync does the actual file backups, rsnapshot is responsible for the overall management of the backups.
In my case, I want it to schedule a nested and rotating series of incremental backups for my systems.
I want the schedule and the backup increments to be:</p>
<ul>
<li>Every 4 hours, create an incremental backup, and store all of them for the past 24 hours</li>
<li>Create a daily incremental backups (from the last hourly backup), and store a daily backup for the past 7 days</li>
<li>Create a weekly incremental backups, and store them for the past 4 weeks</li>
<li>Create monthly incremental backups, and store for the past 3 months</li>
</ul>
<p>When making the backups, the contents of <code>/dev</code>, <code>/proc</code>, <code>/sys</code>, <code>/tmp</code>, and <code>/run</code> should be excluded
because they are populated at boot (while the directories themselves are not created).
The file <code>/lost+found</code> is filesystem-specific and doesn't need to be copied.
(Note: If you plan on backing up your system somewhere other than <code>/mnt</code> or <code>/media</code>
don't forget to add it to the list, to avoid an infinite loop.)</p>
<p>rsnapshot also provides a non-command-line method for excluding file, which is what I'm using.
Specifically, I have defined exclusion files for Linux and Windows based systems.
For Linux, the file is called <code>rsync-exclude-desktop</code> and <code>rsync-exclude-RPi</code> and look something like this:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>- /var/lib/pacman/sync/*
- /lost+found
- /media/*
- /cdrom/*
- /proc/*
- /mnt/*
- /run/*
- /tmp/*
- /sys/*
- /dev/*
</pre></div>


<p>For Windows, the file is called <code>rsync-exclude-windows</code>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>- /cygdrive/c/System\ Volume\ Information/*
- /cygdrive/c/Windows/System32/winevt/*
- /cygdrive/c/Windows/System32/catroot/*
- /cygdrive/c/Windows/System32/catroot2/*
- /cygdrive/c/Windows/System32/config/*
- /cygdrive/c/Windows/ServiceProfiles/*
- /cygdrive/c/ProgramData/Microsoft/*
- /cygdrive/c/Windows/System32/wdi/*
- /cygdrive/c/Windows/System32/wfp/*
- /cygdrive/c/Windows/System32/sru/*
- /cygdrive/c/proc/sys/Device/*
- /cygdrive/c/proc/registry*
- /cygdrive/c/Windows/Logs/*
- /cygdrive/c/hiberfil.sys
- /cygdrive/c/pagefile.sys
- /cygdrive/c/swapfile.sys
- /proc/sys/Sessions/
- UsrClass.dat
- ntuser*
- NTUSER*
- *Cache*
- *cache*
- *Lock*
- *lock*
- *LOG*
- *log*
- *.tmp
</pre></div>


<p>To implement the above backup rules (and many others),
you need to edit a configuration file<sup id="fnref:I"><a class="footnote-ref" href="#fn:I" rel="footnote">10</a></sup> located at <code>/etc/rsnapshot.conf</code>.
<strong>Note: This file must only have tabs between arguments. No spaces.</strong>
(It's a quirk of rsnapshot that it requires tabs.)
The configuration elements I edited are below
(<code>/usr/share/doc/rsnapshot/examples/rsnapshot.conf.default.gz</code>
can be used as a starting point):</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic"># location where backups will be stored</span>
snapshot_root   /mnt/backup/

<span style="color: #0099FF; font-style: italic"># rsync command executed on the remote system</span>
cmd_rsync   /usr/bin/rsync

<span style="color: #0099FF; font-style: italic"># incremental backup rules</span>
retain      hourly  6
retain      daily   7
retain      weekly  4
retain      monthly 3

<span style="color: #0099FF; font-style: italic"># rsnapshot&#39;s log file</span>
logfile /var/log/rsnapshot.log

<span style="color: #0099FF; font-style: italic"># All rsync commands have at least these options set.</span>
rsync_short_args    -aev
rsync_long_args --delete --numeric-ids --relative --delete-excluded

<span style="color: #0099FF; font-style: italic"># ssh args passed</span>
ssh_args    -i /home/backup_user/.ssh/id_rsa

<span style="color: #0099FF; font-style: italic"># systems to be backed up, what high level directory name is to be used</span>
<span style="color: #0099FF; font-style: italic"># and the additional arguments to pass to rsync</span>
backup  /   desktop/    <span style="color: #003333">exclude_file</span><span style="color: #555555">=</span>/home/backup_user/rsync-exclude-desktop
backup  backup_user@RedRPi:/    RedRPi/ <span style="color: #003333">exclude_file</span><span style="color: #555555">=</span>/home/backup_user/rsync-exclude-RPi,+rsync_long_args<span style="color: #555555">=</span>--rsync-path<span style="color: #555555">=</span>/home/backup_user/bin/rsync-wrapper.sh
backup  backup_user@BlackRPi:/  BlackRPi/   <span style="color: #003333">exclude_file</span><span style="color: #555555">=</span>/home/backup_user/rsync-exclude-RPi,+rsync_long_args<span style="color: #555555">=</span>--rsync-path<span style="color: #555555">=</span>/home/backup_user/bin/rsync-wrapper.sh
backup  Sara@SaraPC:/   SaraPC/ <span style="color: #003333">exclude_file</span><span style="color: #555555">=</span>/home/backup_user/rsync-exclude-windows,+rsync_long_args<span style="color: #555555">=</span>--fake-super
</pre></div>


<p>In my backup scheme, I have several remote systems (i.e. RedRPi, BlackRPi, and SaraPC),
and a backup server itself (i.e. desktop).
All system will use a common user called <code>backup_user</code>,
who's only purpose is to support the backup process.
From the backup system, we'll be able to logon to each remote system using
the <code>backup_user</code> ssh public key.
The main trick is to set sudoers on the remote system such that it allow rsync
root access to <code>backup_user</code>,
and it tell rsnapshot to use additional parameters when calling rsync.
This all required to maintain the security of the remote systems, and was discussed in the text above.</p>
<h2>Testing rsnapshot</h2>
<p>rsnapshot provides an easy way to check that your configuration file doesn't contain any syntax errors.
Simply type:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsnapshot configtest
</pre></div>


<p>If all is well, it will say ‘syntax ok’.
If there is a problem, it will spit errors at you.
If you get errors, check that you have separated items in the file using tabs
(spaces are not allowed in the configuration file).</p>
<p>The final step to test your configuration is to run rsnapshot in test mode, using the <code>-t</code> option:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo rsnapshot -t hourly
</pre></div>


<p>This tells rsnapshot to simulate an "hourly" backup.
It should print out the commands it will perform when it runs for real.
If all is well, then remove the <code>-t</code> and run it for real to create the initial backup.
This initial run is likely to run a long time, and shouldn't be do via cron as discussed below.</p>
<h2>Scheduling (Automating) Backups in crontab</h2>
<p>Linux <a href="http://en.wikipedia.org/wiki/Cron">cron</a><sup id="fnref:J"><a class="footnote-ref" href="#fn:J" rel="footnote">11</a></sup> is used to schedule commands to be executed periodically.
You can setup commands or scripts, which will be repeatedly run at a set time.</p>
<p>For crontab, I created a wrapper script and
placed it in <code>/home/backup_user/bin/rsnapshot-wrapper.sh</code>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/bin/bash</span>

<span style="color: #0099FF; font-style: italic"># This script is a wrapper around rsnapshot, so status information is logged</span>
<span style="color: #0099FF; font-style: italic"># and notification are made via Pushover app.  It also makes sure the log file</span>
<span style="color: #0099FF; font-style: italic"># doesn&#39;t grow too large.</span>

<span style="color: #0099FF; font-style: italic"># Capture scripts start time</span>
<span style="color: #003333">STARTTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%s<span style="color: #CC3300">`</span>

<span style="color: #0099FF; font-style: italic"># Location of the Log file</span>
<span style="color: #003333">LOG</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/home/backup_user/backup.log&quot;</span>

<span style="color: #0099FF; font-style: italic"># Number of lines in the log file required to trigger it&#39;s truncation</span>
<span style="color: #003333">MAXLINES</span><span style="color: #555555">=</span>7000

<span style="color: #0099FF; font-style: italic"># Number of lines remaining in the log file after its truncated</span>
<span style="color: #003333">MINLINES</span><span style="color: #555555">=</span>2000

<span style="color: #0099FF; font-style: italic"># Calculate the size of the Log file</span>
<span style="color: #003333">LOGSIZE</span><span style="color: #555555">=</span><span style="color: #006699; font-weight: bold">$(</span> wc <span style="color: #003333">$LOG</span> | awk <span style="color: #CC3300">&#39;{ print $1 }&#39;</span> <span style="color: #006699; font-weight: bold">)</span>

<span style="color: #0099FF; font-style: italic"># Place in the log file information concerning the execution of this script</span>
<span style="color: #336666">echo</span> -e <span style="color: #CC3300">&quot;\n\n+++++ rsnapshot script started on `date` +++++&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;options passed to rsnapshot: &quot;</span> <span style="color: #003333">$@</span> &gt;&gt; <span style="color: #003333">$LOG</span>

<span style="color: #0099FF; font-style: italic"># Now execute the script</span>
/usr/bin/sudo /usr/bin/rsnapshot <span style="color: #CC3300">&quot;</span><span style="color: #003333">$@</span><span style="color: #CC3300">&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span> 2&gt;&amp;1
<span style="color: #003333">EXITSTATUS</span><span style="color: #555555">=</span><span style="color: #003333">$?</span>

<span style="color: #0099FF; font-style: italic"># Capture scripts end time and calculate run time</span>
<span style="color: #003333">ENDTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%s<span style="color: #CC3300">`</span>
<span style="color: #003333">INTERVAL</span><span style="color: #555555">=</span><span style="color: #006699; font-weight: bold">$((</span>ENDTIME <span style="color: #555555">-</span> STARTTIME<span style="color: #006699; font-weight: bold">))</span>
<span style="color: #003333">RUNTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #006699; font-weight: bold">$((</span><span style="color: #003333">$INTERVAL</span> <span style="color: #555555">/</span> <span style="color: #FF6600">60</span><span style="color: #006699; font-weight: bold">))</span><span style="color: #CC3300"> min. </span><span style="color: #006699; font-weight: bold">$((</span><span style="color: #003333">$INTERVAL</span> <span style="color: #555555">%</span> <span style="color: #FF6600">60</span><span style="color: #006699; font-weight: bold">))</span><span style="color: #CC3300"> sec.&quot;</span>

<span style="color: #0099FF; font-style: italic"># Place time-stamped completion message in the Log</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;rsnapshot exited with status </span><span style="color: #003333">$EXITSTATUS</span><span style="color: #CC3300">&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;+++++ rsnapshot ran&quot;</span> <span style="color: #003333">$RUNTIME</span> <span style="color: #CC3300">&quot;and script completed on `date` +++++&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>

<span style="color: #0099FF; font-style: italic"># Send status notification to Pushover app</span>
/home/jeff/bin/apprise -t <span style="color: #CC3300">&quot;Incremental Backup Status&quot;</span> -m <span style="color: #CC3300">&quot;Filesystem backup took </span><span style="color: #003333">$RUNTIME</span><span style="color: #CC3300"> and completed on `date` with exit status </span><span style="color: #003333">$EXITSTATUS</span><span style="color: #CC3300">.  Log file </span><span style="color: #003333">$LOG</span><span style="color: #CC3300"> has </span><span style="color: #003333">$LOGSIZE</span><span style="color: #CC3300"> lines.&quot;</span>

<span style="color: #0099FF; font-style: italic"># Truncate the log file if needed</span>
<span style="color: #006699; font-weight: bold">if</span> <span style="color: #555555">[</span> <span style="color: #003333">$LOGSIZE</span> -ge <span style="color: #003333">$MAXLINES</span> <span style="color: #555555">]</span>
<span style="color: #006699; font-weight: bold">then</span>
    <span style="color: #003333">LINECUT</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>expr <span style="color: #003333">$LOGSIZE</span> - <span style="color: #003333">$MINLINES</span><span style="color: #CC3300">`</span>
    sed -i <span style="color: #CC3300">&quot;1,</span><span style="color: #003333">$LINECUT</span><span style="color: #CC3300"> d&quot;</span> <span style="color: #003333">$LOG</span>
    sed -i <span style="color: #CC3300">&quot;1i ////////////////  File truncated here on `date`. //////////////// &quot;</span> <span style="color: #003333">$LOG</span>
<span style="color: #006699; font-weight: bold">fi</span>
</pre></div>


<p>Sometime, such as when upgrading my operating system,
I want to perform a true full backup.
That is, a true copy and not using
<a href="http://www.linfo.org/hard_link.html">hard links</a> to files that haven't changed.
To do this, I create the script below,
which even prompts me for the system I wish to backup.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/bin/bash</span>

<span style="color: #0099FF; font-style: italic">#set -x</span>

<span style="color: #0099FF; font-style: italic"># arguments to be used with rsync</span>
<span style="color: #003333">ARGS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;-aev --delete --numeric-ids --relative --delete-excluded&quot;</span>
<span style="color: #003333">EXCL_DESKTOP</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;--exclude-from=/home/backup_user/rsync-exclude-desktop --exclude=mnt/backup&quot;</span>
<span style="color: #003333">EXCL_RPI</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;--exclude-from=/home/backup_user/rsync-exclude-RPi&quot;</span>
<span style="color: #003333">EXCL_WINDOWS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;--exclude-from=/home/backup_user/rsync-exclude-windows&quot;</span>
<span style="color: #003333">REMOTE_WRAPPER</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;--rsync-path=/home/backup_user/bin/rsync-wrapper.sh&quot;</span>
<span style="color: #003333">SSH_ARGS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;--rsh=\&quot;/usr/bin/ssh -o CheckHostIP=no -i /home/backup_user/.ssh/id_rsa\&quot;&quot;</span>

<span style="color: #0099FF; font-style: italic"># Location of the Log file</span>
<span style="color: #003333">LOG</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/home/backup_user/backup.log&quot;</span>

<span style="color: #003333">DIR</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%Y_%b_%d_%H_%M<span style="color: #CC3300">`</span>

<span style="color: #006699; font-weight: bold">while</span> true; <span style="color: #006699; font-weight: bold">do</span>
    <span style="color: #336666">read</span> -p <span style="color: #CC3300">&quot;What would you like to backup? (&#39;desktop&#39;, &#39;RedRPi&#39;, &#39;BlackRPi&#39;, or &#39;SaraPC&#39;)  &quot;</span> answer
    <span style="color: #006699; font-weight: bold">case</span> <span style="color: #003333">$answer</span> in
        <span style="color: #CC3300">&#39;desktop&#39;</span> <span style="color: #555555">)</span>
            <span style="color: #003333">ARGUMENTS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGS</span><span style="color: #CC3300"> </span><span style="color: #003333">$EXCL_DESKTOP</span><span style="color: #CC3300">&quot;</span>
            <span style="color: #003333">SOURCE</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/.&quot;</span>
            <span style="color: #003333">DESTINATION</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/mnt/backup/full-backup/desktop/</span><span style="color: #003333">$DIR</span><span style="color: #CC3300">&quot;</span>
            break;;
        <span style="color: #CC3300">&#39;RedRPi&#39;</span> <span style="color: #555555">)</span>
            <span style="color: #003333">ARGUMENTS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGS</span><span style="color: #CC3300"> </span><span style="color: #003333">$EXCL_RPI</span><span style="color: #CC3300"> </span><span style="color: #003333">$REMOTE_WRAPPER</span><span style="color: #CC3300"> </span><span style="color: #003333">$SSH_ARGS</span><span style="color: #CC3300">&quot;</span>
            <span style="color: #003333">SOURCE</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;backup_user@RedRPi:/&quot;</span>
            <span style="color: #003333">DESTINATION</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/mnt/backup/full-backup/RedRPi/</span><span style="color: #003333">$DIR</span><span style="color: #CC3300">&quot;</span>
            break;;
        <span style="color: #CC3300">&#39;BlackRPi&#39;</span> <span style="color: #555555">)</span>
            <span style="color: #003333">ARGUMENTS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGS</span><span style="color: #CC3300"> </span><span style="color: #003333">$EXCL_RPI</span><span style="color: #CC3300"> </span><span style="color: #003333">$REMOTE_WRAPPER</span><span style="color: #CC3300"> </span><span style="color: #003333">$SSH_ARGS</span><span style="color: #CC3300">&quot;</span>
            <span style="color: #003333">SOURCE</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;backup_user@BlackRPi:/&quot;</span>
            <span style="color: #003333">DESTINATION</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/mnt/backup/full-backup/BlackRPi/</span><span style="color: #003333">$DIR</span><span style="color: #CC3300">&quot;</span>
            break;;
        <span style="color: #CC3300">&#39;SaraPC&#39;</span> <span style="color: #555555">)</span>
            <span style="color: #003333">ARGUMENTS</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGS</span><span style="color: #CC3300"> </span><span style="color: #003333">$EXCL_WINDOWS</span><span style="color: #CC3300"> --fake-super </span><span style="color: #003333">$SSH_ARGS</span><span style="color: #CC3300">&quot;</span>
            <span style="color: #003333">SOURCE</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;Sara@SaraPC:/&quot;</span>
            <span style="color: #003333">DESTINATION</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;/mnt/backup/full-backup/SaraPC/</span><span style="color: #003333">$DIR</span><span style="color: #CC3300">&quot;</span>
            break;;
        <span style="color: #555555">[</span>Qq<span style="color: #555555">]</span>* <span style="color: #555555">)</span>
            <span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;Exiting script.&quot;</span>
            exit;;
        * <span style="color: #555555">)</span>
            <span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;Please answer &#39;desktop&#39;, &#39;RedRPi&#39;, &#39;BlackRPi&#39;, &#39;SaraPC&#39; or &#39;q&#39; to quit&quot;</span>;;
    <span style="color: #006699; font-weight: bold">esac</span>
<span style="color: #006699; font-weight: bold">done</span>

<span style="color: #0099FF; font-style: italic"># Capture scripts start time</span>
<span style="color: #003333">STARTTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%s<span style="color: #CC3300">`</span>

<span style="color: #0099FF; font-style: italic"># Place in the log file information concerning the execution of this script</span>
<span style="color: #336666">echo</span> -e <span style="color: #CC3300">&quot;\n\n####&quot;</span> <span style="color: #003333">$answer</span> <span style="color: #CC3300">&quot;full-backup script started on `date` ####&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> -n <span style="color: #CC3300">&quot;options passed to rsync: &quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGUMENTS</span><span style="color: #CC3300"> </span><span style="color: #003333">$SOURCE</span><span style="color: #CC3300"> </span><span style="color: #003333">$DESTINATION</span><span style="color: #CC3300">&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span>

<span style="color: #0099FF; font-style: italic"># Now execute the script, also capture scripts end time, calculate run time,</span>
<span style="color: #0099FF; font-style: italic"># and send status notification to Pushover app</span>
<span style="color: #555555">(</span> <span style="color: #003333">STARTTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%s<span style="color: #CC3300">`</span> ; <span style="color: #336666">eval</span> /usr/bin/rsync <span style="color: #CC3300">&quot;</span><span style="color: #003333">$ARGUMENTS</span><span style="color: #CC3300"> </span><span style="color: #003333">$SOURCE</span><span style="color: #CC3300"> </span><span style="color: #003333">$DESTINATION</span><span style="color: #CC3300">&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span> 2&gt;&amp;<span style="color: #FF6600">1</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #003333">EXITSTATUS</span><span style="color: #555555">=</span><span style="color: #003333">$?</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;rsync terminated with exit status </span><span style="color: #003333">$EXITSTATUS</span><span style="color: #CC3300">.&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;####&quot;</span> <span style="color: #003333">$answer</span> <span style="color: #CC3300">&quot;full-backup script completed at `date` ####&quot;</span> &gt;&gt; <span style="color: #003333">$LOG</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #003333">ENDTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">`</span>date +%s<span style="color: #CC3300">`</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #003333">INTERVAL</span><span style="color: #555555">=</span><span style="color: #006699; font-weight: bold">$((</span>ENDTIME <span style="color: #555555">-</span> STARTTIME<span style="color: #006699; font-weight: bold">))</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #003333">RUNTIME</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;</span><span style="color: #006699; font-weight: bold">$((</span><span style="color: #003333">$INTERVAL</span> <span style="color: #555555">/</span> <span style="color: #FF6600">60</span><span style="color: #006699; font-weight: bold">))</span><span style="color: #CC3300"> min. </span><span style="color: #006699; font-weight: bold">$((</span><span style="color: #003333">$INTERVAL</span> <span style="color: #555555">%</span> <span style="color: #FF6600">60</span><span style="color: #006699; font-weight: bold">))</span><span style="color: #CC3300"> sec.&quot;</span> ;<span style="color: #CC3300; font-weight: bold">\</span>
/home/jeff/bin/apprise -t <span style="color: #CC3300">&quot;Full Backup Status&quot;</span> -m <span style="color: #CC3300">&quot;Filesystem backup took </span><span style="color: #003333">$RUNTIME</span><span style="color: #CC3300"> and completed on `date` with exit status </span><span style="color: #003333">$EXITSTATUS</span><span style="color: #CC3300">.&quot;</span> <span style="color: #555555">)</span> &amp;

<span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;Full Backup Underway From &#39;</span><span style="color: #003333">$SOURCE</span><span style="color: #CC3300">&#39; To &#39;</span><span style="color: #003333">$DESTINATION</span><span style="color: #CC3300">&#39;&quot;</span>
</pre></div>


<p>Under the <code>backup_user</code> account I established the Cron job for the backups.
You can use <code>sudo crontab -l</code> to list the contents of crontab.
To update it, use <code>crontab -e</code> and enter the following
(Also, restart cron with <code>sudo service cron restart</code> to make sure the changes are in effect):</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic"># Each task to run has to be defined through a single line</span>
<span style="color: #0099FF; font-style: italic"># indicating with different fields when the task will be run</span>
<span style="color: #0099FF; font-style: italic"># and what command to run for the task</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># To define the time you can provide concrete values for</span>
<span style="color: #0099FF; font-style: italic"># minute (m), hour (h), day of month (dom), month (mon),</span>
<span style="color: #0099FF; font-style: italic"># and day of week (dow) or use &#39;*&#39; in these fields (for &#39;any&#39;).#</span>
<span style="color: #0099FF; font-style: italic"># Notice that tasks will be started based on the cron&#39;s system</span>
<span style="color: #0099FF; font-style: italic"># daemon&#39;s notion of time and timezones.</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Output of the crontab jobs (including errors) is sent through</span>
<span style="color: #0099FF; font-style: italic"># email to the user the crontab file belongs to (unless redirected).</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># For example, you can run a backup of all your user accounts</span>
<span style="color: #0099FF; font-style: italic"># at 5 a.m every week with:</span>
<span style="color: #0099FF; font-style: italic"># 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Instead of the first five fields, one of eight special strings may be applied:</span>
<span style="color: #0099FF; font-style: italic"># string         meaning</span>
<span style="color: #0099FF; font-style: italic"># ------         -------</span>
<span style="color: #0099FF; font-style: italic"># @reboot        Run once, at startup.</span>
<span style="color: #0099FF; font-style: italic"># @yearly        Run once a year, &quot;0 0 1 1 *&quot;.</span>
<span style="color: #0099FF; font-style: italic"># @annually      (same as @yearly)</span>
<span style="color: #0099FF; font-style: italic"># @monthly       Run once a month, &quot;0 0 1 * *&quot;.</span>
<span style="color: #0099FF; font-style: italic"># @weekly        Run once a week, &quot;0 0 * * 0&quot;.</span>
<span style="color: #0099FF; font-style: italic"># @daily         Run once a day, &quot;0 0 * * *&quot;.</span>
<span style="color: #0099FF; font-style: italic"># @midnight      (same as @daily)</span>
<span style="color: #0099FF; font-style: italic"># @hourly        Run once an hour, &quot;0 * * * *&quot;.</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Examples</span>
<span style="color: #0099FF; font-style: italic"># @reboot &lt;command&gt; #Runs at boot</span>
<span style="color: #0099FF; font-style: italic"># @yearly &lt;command&gt; #Runs once a year [0 0 1 1 *]</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># For more information see the manual pages of crontab(5) and cron(8)</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic">#     +------------- minutes (0 - 59)</span>
<span style="color: #0099FF; font-style: italic">#     |      +----------- hour (0 - 23)</span>
<span style="color: #0099FF; font-style: italic">#     |      |          +--------- day of month (1 - 31)</span>
<span style="color: #0099FF; font-style: italic">#     |      |          |         +------- month (1 - 12)</span>
<span style="color: #0099FF; font-style: italic">#     |      |          |         |         +----- day of week (0 - 6) (Sunday = 0)</span>
<span style="color: #0099FF; font-style: italic">#     |      |          |         |         |            +--- command to be executed</span>
<span style="color: #0099FF; font-style: italic">#     |      |          |         |         |            |</span>
<span style="color: #0099FF; font-style: italic">#     |      |          |         |         |            |</span>
<span style="color: #0099FF; font-style: italic">#     m      h         dom       mon       dow</span>
<span style="color: #0099FF; font-style: italic">#   minute  hour  day-of-month  month   day-of-week   command</span>
      <span style="color: #FF6600">0</span>     */4         *         *         *         /home/backup_user/bin/rsnapshot-wrapper.sh hourly
     <span style="color: #FF6600">30</span>      <span style="color: #FF6600">2</span>          *         *         *         /home/backup_user/bin/rsnapshot-wrapper.sh daily
     <span style="color: #FF6600">30</span>     <span style="color: #FF6600">10</span>          *         *         <span style="color: #FF6600">6</span>         /home/backup_user/bin/rsnapshot-wrapper.sh weekly
     <span style="color: #FF6600">30</span>     <span style="color: #FF6600">14</span>          <span style="color: #FF6600">1</span>         *         *         /home/backup_user/bin/rsnapshot-wrapper.sh monthly
</pre></div>


<p>Finally, within some of the scripts above,
you'll the utility <code>apprise</code>.
This utility make use of the push notification <a href="https://pushover.net/">Pushover</a>:</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic">#!/bin/bash</span>

<span style="color: #0099FF; font-style: italic"># This utility does a push notification to the service Pushover - https://pushover.net/</span>

<span style="color: #003333">APPTOKEN</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;&lt;token&gt;&quot;</span>
<span style="color: #003333">USERKEY</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;&lt;key&gt;&quot;</span>

<span style="color: #0099FF; font-style: italic"># Parse command line options</span>
<span style="color: #003333">USAGE</span><span style="color: #555555">=</span><span style="color: #CC3300">&quot;Usage: `basename </span><span style="color: #003333">$0</span><span style="color: #CC3300">` [-h] -t title -m message&quot;</span>
<span style="color: #006699; font-weight: bold">while</span> <span style="color: #336666">getopts</span> ht:m: OPT; <span style="color: #006699; font-weight: bold">do</span>
    <span style="color: #006699; font-weight: bold">case</span> <span style="color: #CC3300">&quot;</span><span style="color: #003333">$OPT</span><span style="color: #CC3300">&quot;</span> in
        h<span style="color: #555555">)</span>
            <span style="color: #336666">echo</span> <span style="color: #003333">$USAGE</span>
            <span style="color: #336666">exit</span> 0
            ;;
        t<span style="color: #555555">)</span>
            <span style="color: #003333">TITLE</span><span style="color: #555555">=</span><span style="color: #003333">$OPTARG</span>
            ;;
        m<span style="color: #555555">)</span>
            <span style="color: #003333">MESSAGE</span><span style="color: #555555">=</span><span style="color: #003333">$OPTARG</span>
            ;;
        <span style="color: #CC3300; font-weight: bold">\?</span><span style="color: #555555">)</span>
            <span style="color: #0099FF; font-style: italic"># getopts issues an error message</span>
            <span style="color: #336666">echo</span> <span style="color: #003333">$USAGE</span> &gt;&amp;2
            <span style="color: #336666">exit</span> 1
            ;;
    <span style="color: #006699; font-weight: bold">esac</span>
<span style="color: #006699; font-weight: bold">done</span>

<span style="color: #0099FF; font-style: italic"># Send message to Pushover to create notification</span>
curl --silent <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;token=</span><span style="color: #003333">$APPTOKEN</span><span style="color: #CC3300">&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;user=</span><span style="color: #003333">$USERKEY</span><span style="color: #CC3300">&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;message=</span><span style="color: #003333">$MESSAGE</span><span style="color: #CC3300">&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;device=desktop&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;title=</span><span style="color: #003333">$TITLE</span><span style="color: #CC3300">&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    -F <span style="color: #CC3300">&quot;sound=spacealarm&quot;</span> <span style="color: #CC3300; font-weight: bold">\</span>
    https://api.pushover.net/1/messages.json | grep <span style="color: #CC3300">&#39;&quot;status&quot;:1&#39;</span> &gt; /dev/null

<span style="color: #0099FF; font-style: italic"># Check the exit code to identify an error</span>
<span style="color: #006699; font-weight: bold">if</span> <span style="color: #555555">[</span> <span style="color: #003333">$?</span> -eq <span style="color: #FF6600">0</span> <span style="color: #555555">]</span>;
    <span style="color: #006699; font-weight: bold">then</span>
        <span style="color: #336666">exit</span> 0
    <span style="color: #006699; font-weight: bold">else</span>
        <span style="color: #336666">echo</span> <span style="color: #CC3300">&quot;apprise failed&quot;</span>
        <span style="color: #336666">exit</span> 1
<span style="color: #006699; font-weight: bold">fi</span>
</pre></div>


<h2>Increased Security</h2>
<p>The final step is to lock all this down.
To increase the security of the overall scheme,
on the remote systems and on the local system,
remove the user password from the <code>backup_user</code>
and set the shell to a NOOP command.</p>
<div class="codehilite" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span><span style="color: #0099FF; font-style: italic"># increase security by deleting password and remove login shell</span>
sudo passwd --delete backup_user
sudo usermod -s /bin/false backup_user
</pre></div>


<h2>Monitoring rsnapshot</h2>
<p>Monitoring and testing is an essential part of any backup procedure.
There's nothing worse than finding out
that your backup hasn't been working for six months on the day that your system crashes.
rsnapshot has a log file that records warnings and error messages.
You can find/open it here: <code>/var/log/rsnapshot.log</code>
Inspect this log regularly to make sure your backup jobs are running smoothly.
You can increase or decrease the level of logging detail in the configuration file <code>/etc/rsnapshot.conf</code>.</p>
<h2>Backup from Windows Machines to Linux</h2>
<p>Backing up Windows systems has its own special challenges, but utilities exist to help.
<a href="http://www.cygwin.com/">Cygwin</a> is a a collection of tools that provide a Linux look and feel environment for Windows.
If you install it, you can use linux commands and services on your Windows.
Cygwin contains a package with <a href="http://cygwin.com/cgi-bin2/package-cat.cgi?file=x86%2Frsync%2Frsync-3.0.9-1&amp;grep=rsync">its version of rsync</a>
to make backups from the Windows based computer.
With Cygwin's rsync and the rsnapshot running on the Linux backup server,
you can set up a remote backup for the Microsoft Windows box.</p>
<p>To do the install the cygwin <code>rsync</code>, <code>ssh</code>, etc. tools required to support the rsnapshot backup,
you'll follow a similar design pattern used above for the Linux boxes.
Follow this procedure:</p>
<h3>Install Cygwin Tools</h3>
<ul>
<li>From the <a href="http://www.cygwin.com/">cygwin site</a>, download and run the setup program.  (Make sure to keep the setup program, since it is used to install additional Cygwin packages, if you so desire.)</li>
<li>Run your cygwin <code>setup.exe</code> and expand the categories to find "rsync" and "ssh".  You'll find them under the "Net" packages.</li>
<li>When the install is complete, the <code>rsync</code> and <code>ssh</code> programs (and many more) will be located in <code>C:\cygwin64\bin</code>. (This is equivalent to <code>/bin</code> when your running a <code>bash</code> shell in cygwin.)</li>
<li>In Windows, open a <a href="http://www.howtogeek.com/howto/windows-vista/run-a-command-as-administrator-from-the-windows-vista-run-box/">Command Prompt (Admin) window</a>.  Within this window, get a bash shell via the command <code>C:\cygwin64\bin\bash</code>.  Next execute <code>export Path=/bin:$PATH</code>.</li>
</ul>
<h3>Get ssh Operational</h3>
<ul>
<li>Now make a home directory for the cygwin user, in my case this was <code>mkdir /home/Sara</code> and then <code>cd /home/Sara</code>.</li>
<li>Create a <code>ssh</code> public/private keys with the following command: <code>ssh-keygen -t rsa</code>.</li>
<li>Now start up the <code>ssh</code> services by following the instructions of "<a href="http://lifehacker.com/205090/geek-to-live--set-up-a-personal-home-ssh-server">Geek to Live: Set up a personal, home SSH server</a>".</li>
<li>Find out the name of the windows system via <code>hostname</code> (it's SaraPC).</li>
<li>In order to access the <code>ssh</code> server from the backup Linux box, the <code>ssh</code> port of 22 must be open in the Windows Firewall. You can check ports status by attempting connect via <code>ssh</code> (e.g. <code>ssh Sara@SaraPC</code>).  If this command appears to hang or time out (as it did for me), the port is likely blocked.  You'll need to go to your <a href="http://windows.microsoft.com/en-us/windows/open-port-windows-firewall#1TC=windows-7">Windows Firewall</a> and open port 22.</li>
<li>Transfer the public key for the <code>backup_user</code> on the Linux Backup server to <code>/home/Sara/.ssh/authorized_keys</code>.</li>
<li>Make sure that in the files <code>/etc/ssh/sshd_config</code> and <code>/etc/ssh/ssh_config</code> that you have <code>RSAAuthentication yes</code> and <code>PubKeyAuthentication yes</code>.</li>
</ul>
<h3>Test ssh and rsync</h3>
<ul>
<li>On the Linux Backup server, login as the <code>backup_user</code> user.</li>
<li>Test the connection via <code>ssh Sara@SaraPC</code> in a terminal window on the Linux box (note to self: Case is important!).  You should login without a password.</li>
<li>Test rsync via the command <code>sudo rsync -azv --fake-super Sara@SaraPC:/home/Sara /mnt/backup/rsync-test9</code>. You'll want to use the <code>--fake-super</code> option to suppress some i<a href="https://digitaldj.net/blog/2011/04/07/rsync-3-0-8-windows-and-chown/">issues with group ids</a>.</li>
<li>Test the <code>/etc/rsnapshot.conf</code> given earlier by running <code>rsnapshot hourly</code>.</li>
</ul>
<h2>Restore Files with rsnapshot</h2>
<p>Restoring files are an no brainier because the backups are plain directories.
You can open a file browser or a terminal, enter a snapshot from a few hours/days/weeks/months ago,
find a working directory where your files are store, and copy them to where their needed.
In other words, you can use any regular tools on any snapshot.
No need to “revert” or “restore” files from backup, or run any special software.
This is mighty convenient, intuitive, and fool proof.</p>
<h2>Sources</h2>
<p>I found these articles useful for writing this post and setting up my rsych / rsnapshot backup scheme.</p>
<h3>rsync</h3>
<ul>
<li><a href="http://www.thegeekstuff.com/2010/09/rsync-command-examples/">How to Backup Linux? 15 rsync Command Examples</a></li>
<li><a href="http://www.tecmint.com/rsync-local-remote-file-synchronization-commands/">Rsync (Remote Sync): 10 Practical Examples of Rsync Command in Linux</a></li>
<li><a href="http://www.thegeekstuff.com/2011/01/rsync-exclude-files-and-folders/">6 rsync Examples to Exclude Multiple Files and Directories using exclude-from</a></li>
<li><a href="http://www.thegeekstuff.com/2011/07/rsync-over-ssh-without-password/">How to Setup Rsync with SSH on UNIX / Linux (rsync without password)</a></li>
<li><a href="http://www.mikerubel.org/computers/rsync_snapshots/">Easy Automated Snapshot-Style Backups with Linux and Rsync</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Full_System_Backup_with_rsync">Full System Backup with rsync</a></li>
</ul>
<h3>rsnapshot</h3>
<ul>
<li><a href="https://kamaradski.com/1245/how-to-install-and-setup-rsnapshot-incremental-remote-backup">How to install and setup Rsnapshot incremental remote backup</a></li>
<li><a href="http://www.cyberciti.biz/faq/linux-rsnapshot-backup-howto/">Debian / Ubuntu Linux Install and Configure Remote Filesystem Snapshot with rsnapshot Incremental Backup Utility</a></li>
<li><a href="http://www.tecmint.com/rsnapshot-a-file-system-backup-utility-for-linux/">Rsnapshot (Rsync Based) – A Local/Remote File System Backup Utility for Linux</a></li>
<li><a href="http://www.rsnapshot.org/howto/1.2/rsnapshot-HOWTO.en.html#create_the_config_file">rsnapshot HOWTO</a></li>
<li><a href="http://www.cyberciti.biz/faq/restoring-backup-files-with-rsnapshot-unix-linux-bsd-appleosx/">UNIX / Linux: Rsnapshot Restore Backups</a></li>
<li><a href="https://sites.google.com/site/rsync2u/home/rsync-tutorial/the-exclude-from-option">The "exclude-from" and "recursive" options</a></li>
<li><a href="http://www.evbackup.com/support-misc-redundant-backups-with-rsnapshot/">Implementing Redundant Backups with rsnapshot</a></li>
</ul>
<h3>rsnapshot with root access</h3>
<ul>
<li><a href="http://technokracy.net/2011/01/07/root_sudo_rsnapshot/">Root, Sudo, and Rsnapshot</a></li>
<li><a href="http://dev.kprod.net/?q=linux-backup-rsnapshot-no-root">Backup remote Linux hosts without root access, using rsnapshot</a></li>
<li><a href="http://derek.simkowiak.net/backing-up-multiple-servers-with-rsnapshot/">Backing Up Multiple Servers with Rsnapshot</a></li>
</ul>
<h3>rsync and rsnapshot with Windows</h3>
<ul>
<li><a href="http://www.smellems.com/tiki-read_article.php?articleId=14">Backup from Windows to Linux with Rsync and SSH</a></li>
<li><a href="http://optics.ph.unimelb.edu.au/help/rsync/rsync_pc1.html">Installing ssh and rsync on a Windows machine: minimalist approach</a></li>
<li><a href="http://www.trueblade.com/knowledge/using-rsync-and-cygwin-to-sync-files-from-a-linux-server-to-a-windows-notebook-pc">Using rsync and cygwin to Sync Files from a Linux Server to a Windows Notebook PC</a></li>
<li><a href="http://terokarvinen.com/rsync_from_windows.html">Rsync from Windows</a></li>
</ul>
<h3>SSH</h3>
<ul>
<li><a href="http://www.symantec.com/connect/articles/ssh-host-key-protection">SSH Host Key Protection</a></li>
<li><a href="http://linuxcommando.blogspot.com/2008/10/how-to-disable-ssh-host-key-checking.html">How to disable SSH host key checking</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:A">
<p><strong>NOTE:</strong>
<a href="http://www.lostsaloon.com/technology/understanding-file-linking-hard-link-vs-symbolic-link-in-linux/">Hard links are similar to symlinks</a>.
They are normally created using the <code>ln</code> command but without the <code>-s</code> switch.
A hard link is when two file entries point to the same <a href="http://en.wikipedia.org/wiki/Inode">inode</a> and <a href="http://en.wikipedia.org/wiki/Block_(data_storage)">disk blocks</a>.
Unlike <a href="http://en.wikipedia.org/wiki/Symbolic_link">symlinks</a> there isn't a file and a pointer to the file, but rather two links to the same file.
If you delete either entry the other will remain and will still contain the data.&#160;<a class="footnote-backref" href="#fnref:A" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:A1">
<p><strong>NOTE:</strong>
This assumes local permission on the remote systems to access the files that are to be backed up.
Where the backup user does not have local permission to access files,
the only reasonable alternative may be key-based authentication over SSH for root.&#160;<a class="footnote-backref" href="#fnref:A1" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:B">
<p><strong>NOTE:</strong>
The command <code>ssh-copy-id</code> may not work if your attempting use the
root login instant of pi on the remote machine.
In this case, you'll need to manually move the public key to its destination.
The article "<a href="http://www.tecmint.com/ssh-passwordless-login-using-ssh-keygen-in-5-easy-steps/">Create SSH Passwordless Login Using SSH Keygen</a> can show you how to do this.&#160;<a class="footnote-backref" href="#fnref:B" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:C">
<p><strong>NOTE:</strong>
Because of an abundance of paranoia,
remote root login over <code>ssh</code> session is disabled in some Linux distributions for <a href="http://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html">security reasons</a>.
By default, the Root account password is locked in Ubuntu and most other version of Linux.
The account has no password, even thou it prompts you to provide one.
This means that you cannot login as Root directly or use the su command to become the Root user.
However, since the Root account physically exists it is still possible to
run programs with root-level privileges.
This is where <a href="https://help.ubuntu.com/community/RootSudo">sudo</a> comes in - it allows authorized users (normally "Administrative" users)
to run certain programs as Root without having to know the root password.&#160;<a class="footnote-backref" href="#fnref:C" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:D">
<p><strong>NOTE:</strong>
One of the most common warnings you will likely encounter is a host key error
which may not happen until long after you have made your first connection to a host.
If any of several identifying features of the host change,
a new host key could be created and if that happens your ssh client will let you know
by refusing to log you into that system without first prompting you to confirm the warning,
or may even force you to provide the login's password.
It can be confusing on how to clean this up, but these two articles can help:
<a href="http://xmodulo.com/2013/05/how-to-accept-ssh-host-keys-automatically-on-linux.html">How to accept ssh host keys automatically on Linux</a>
and <a href="http://stackoverflow.com/questions/9299651/warning-permanently-added-to-the-list-of-known-hosts-message-from-git">“Warning: Permanently added to the list of known hosts” message from Git</a>.&#160;<a class="footnote-backref" href="#fnref:D" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:E">
<p><strong>NOTE:</strong>
The suppression of this warning does reduce the security profile of the system.
Instead of suppressing the warning for all ssh access to *RPi,
you could implement this functionality <a href="http://www.garron.me/en/linux/remove-offending-key-ssh.html">solely for the <code>rsync</code> command</a> by using
the option <code>-e "ssh -o CheckHostIP=no -o StrictHostKeyChecking=no"</code>.
See <a href="http://security.stackexchange.com/questions/10532/ecdsa-keys-changed-ssh-insecure-now">ECDSA Keys Changed, SSH insecure now</a>.&#160;<a class="footnote-backref" href="#fnref:E" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:F">
<p><strong>NOTE:</strong>
The sudoers configuration file enables a huge amount of configurability,
including but not limited to: enabling root commands only from the invoking terminal;
not requiring a password for certain commands;
requiring a password per user or group;
requiring re-entry of a password every time or never requiring a password at all for a particular command line.
It can also be configured to permit passing arguments or multiple commands,
and even supports commands with regular expressions.&#160;<a class="footnote-backref" href="#fnref:F" rev="footnote" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:G">
<p><strong>NOTE:</strong>
I choose a UID of 400 so that the <code>backup_user</code> would not appear on the Ubuntu login screen list.
To hide a user from the Ubuntu login screen list,
you should be able to add the name to the hidden-users
list in the file <code>/etc/lightdm/users.conf</code>, but there is a <a href="http://www.cyberciti.biz/faq/howto-change-rename-user-name-id/">problem</a>.
The is an alternative, and that is to choose a UID value less than 500
(See the "minimum-uid" in <code>/etc/lightdm/users.conf</code>).&#160;<a class="footnote-backref" href="#fnref:G" rev="footnote" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:H">
<p><strong>NOTE:</strong>
To automate rsnapshot backup to a remote servers,
you'll also need to set up key-based authentication over SSH on the remote
machines that you want to backup,
so that they can be accessed without need for a password login.
And you need to make sure this arrangement survives a reboot.
To accomplish this, you will need to create an SSH public and private keys to authenticate on the rsnapshot server.
This was all discussed earlier.&#160;<a class="footnote-backref" href="#fnref:H" rev="footnote" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:I">
<p><strong>NOTE:</strong>
The configuration file requires tabs between elements
and all directories require a trailing slash.
Just open the configuration file using a text editor such as <code>vi</code> or <code>gedit</code> but be careful.
Many editors are set to convert any tabs entered by the user to spaces.
This can be a source of great confusion and frustration!&#160;<a class="footnote-backref" href="#fnref:I" rev="footnote" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:J">
<p><strong>NOTE:</strong>
The cron service (daemon) runs in the background and constantly checks the <code>/etc/crontab</code> file,
and <code>/etc/cron.*/</code> directories.
It also checks the <code>/var/spool/cron/</code> directory.
Review the article <a href="https://help.ubuntu.com/community/CronHowto">CronHowTo</a> to see how you can schedule and run tasks
in the background automatically at regular intervals using crontab files.
Crontab ( <strong>cron</strong> <strong>tab</strong>le ) is a file which contains the schedule of cron entries to be run and at specified times.
(If the system isn't running 24x7, consider using <a href="http://www.thegeekstuff.com/2011/05/anacron-examples/">anacron</a>).&#160;<a class="footnote-backref" href="#fnref:J" rev="footnote" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
</ol>
</div><script type= "text/javascript">
    if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
        var mathjaxscript = document.createElement('script');
        mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
        mathjaxscript.type = 'text/javascript';
        mathjaxscript.src = 'https:' == document.location.protocol
		? 'https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js'
		: 'http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
        mathjaxscript[(window.opera ? "innerHTML" : "text")] =
            "MathJax.Hub.Config({" +
            "    config: ['MMLorHTML.js']," +
            "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
            "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
            "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
            "    displayAlign: 'center'," +
            "    displayIndent: '0em'," +
            "    showMathMenu: true," +
            "    tex2jax: { " +
            "        inlineMath: [ ['$','$'] ], " +
            "        displayMath: [ ['$$','$$'] ]," +
            "        processEscapes: true," +
            "        preview: 'TeX'," +
            "    }, " +
            "    'HTML-CSS': { " +
            "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
            "    } " +
            "}); ";
        (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
    }
</script>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar" style="box-shadow: 5px 5px 10px #888888;">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <div style="text-align: center;">
                    <h3><a href="../../../../../pages/about-me/" style="font-family: Knewave, cursive; font-size: 18;">My Electronics Projects And Other Diversions</a>
                    <a href="../../../../../pages/about-me/">
                        <img class="img-rounded" src="../../../../../extra/frustrated-engineer.jpg" alt="Side Bar Picture" height="100%" width="100%">
                    </a>
                </div>

            <font color=#990000>
                <li class="list-group-item"><a href="../../../../../pages/"><h4><i class="fa fa-exclamation-triangle fa-lg"></i><span class="icon-label">Testing Zone</span></h4></a>
                </li>

                <li class="list-group-item"><a href="../../../../../drafts/"><h4><i class="fa fa-edit fa-lg"></i><span class="icon-label">Draft Articles</span></h4></a>
                </li>
            </font>

            <li class="list-group-item"><a href="../../../../../categories.html"><h4><i class="fa fa-folder-open fa-lg"></i><span class="icon-label">Categories</span></h4></a>
            </li>

            <li class="list-group-item"><a href="../../../../../tags.html"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
            </li>

            <li class="list-group-item"><a href="../../../../../index.html"><h4><i class="fa fa-clock-o fa-lg"></i><span class="icon-label">Recent Posts</span></h4></a>
            </li>

            <li class="list-group-item"><a href="../../../../../pages/open-notebook/index.html"><h4><i class="fa fa-book fa-lg"></i><span class="icon-label">Open Notebook</span></h4></a>

<li class="list-group-item"><h4><i class="fa fa-file-text fa-lg"></i><span class="icon-label">Site Pages</span></h4>
    <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="/pages/linux-and-python-packages-for-my-raspberry-pi/index.html" target="_blank">
                RPi Packages
            </a>
        </li>
        <li class="list-group-item">
            <a href="/tag/how-to/index.html" target="_blank">
                How To
            </a>
        </li>
        <li class="list-group-item">
            <a href="/tag/cheat-sheet/index.html" target="_blank">
                Cheat Sheets
            </a>
        </li>
    </ul>
</li>
<li class="list-group-item"><h4><i class="fa fa-puzzle-piece fa-lg"></i><span class="icon-label">MicroContent</span></h4>
    <ul class="list-group" id="wiki">
        <li class="list-group-item">
            <a href="http://127.0.0.1:8080/#Potential Projects" target="_blank">
                Project Ideas
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://127.0.0.1:8080/#Topics for Study" target="_blank">
                Things to Study
            </a>
        </li>
    </ul>
</li>
<li class="list-group-item"><h4><i class="fa fa-link fa-lg"></i><span class="icon-label">External Links</span></h4>
    <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://tiddlywiki.com/" target="_blank">
                TiddlyWiki
            </a>
        </li>
    </ul>
</li>
<li class="list-group-item"><h4><i class="fa fa-group fa-lg"></i><span class="icon-label">Social Media</span></h4>
    <ul class="list-group" id="social">
        <li class="list-group-item"><a href="https://github.com/jeffskinnerbox" target="_blank">
            <i class="fa fa-github"></i> Github
        </a></li>
        <li class="list-group-item"><a href="https://hackaday.io/jeffskinnerbox" target="_blank">
            <i class="fa fa-hacker-news"></i> Hackaday
        </a></li>
        <li class="list-group-item"><a href="https://twitter.com/jeffskinnerbox" target="_blank">
            <i class="fa fa-twitter"></i> Twitter
        </a></li>
        <li class="list-group-item"><a href="https://www.flickr.com/photos/104241758@N03/" target="_blank">
            <i class="fa fa-flickr"></i> Flickr
        </a></li>
        <li class="list-group-item"><a href="https://delicious.com/jeffskinnerbox" target="_blank">
            <i class="fa fa-delicious"></i> Delicious
        </a></li>
        <li class="list-group-item"><a href="https://www.pinterest.com/jeffskinnerbox/my-electronics-projects-and-other-diversions/" target="_blank">
            <i class="fa fa-pinterest"></i> Pinterest
        </a></li>
        <li class="list-group-item"><a href="http://getpocket.com/a/queue/" target="_blank">
            <i class="fa fa-chevron-circle-down"></i> Pocket
        </a></li>
        <li class="list-group-item"><a href="http://jeffskinnerbox.tumblr.com/" target="_blank">
            <i class="fa fa-tumblr"></i> Tumblr
        </a></li>
        <li class="list-group-item"><a href="http://instagram.com/jeffskinnerbox" target="_blank">
            <i class="fa fa-instagram"></i> Instagram
        </a></li>
        <li class="list-group-item"><a href="https://www.facebook.com/jeff.irland" target="_blank">
            <i class="fa fa-facebook"></i> Facebook
        </a></li>
        <li class="list-group-item"><a href="https://linkedin.com/in/jeffreyirland" target="_blank">
            <i class="fa fa-linkedin"></i> Linkedin
        </a></li>
        <li class="list-group-item"><a href="http://www.commandlinefu.com/commands/by/jeffskinnerbox" target="_blank">
            <i class="fa fa-terminal"></i> CommandLineFu
        </a></li>
        <li class="list-group-item"><a href="https://disqus.com/by/jeffskinnerbox/" target="_blank">
            <i class="fa fa-comment"></i> DISQUS
        </a></li>
    </ul>
</li> 

<li class="list-group-item"><h4><i class="fa fa-thumbs-up fa-lg"></i><span class="icon-label">Reposted At</span></h4>
    <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://www.eeweb.com/websites/jeffs-skinner-box" target="_blank">
                EEWeb.com
            </a>
        </li>
    </ul>
</li>
<li class="list-group-item"><h4><i class="fa fa-gears fa-lg"></i><span class="icon-label">Admin</span></h4>
    <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="https://www.google.com/analytics/web/?hl=en#report/visitors-overview/a43272292w73270397p83408137/" target="_blank">
                Google Analytics
            </a>
        </li>
        <li class="list-group-item">
            <a href="https://github.com/jeffskinnerbox/jeffskinnerbox.github.io" target="_blank">
                Web Site Source Code
            </a>
        </li>
    </ul>
</li>
            <li class="list-group-item"><a href="../../../../../pages/this-blog-is-powered-by/index.html"><h4><i class="fa fa-rocket fa-lg"></i><span class="icon-label">This Blog Powered By</span></h4></a>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">This Blog Powered By 
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://tiddlywiki.com/" target="_blank">TiddlyWiki</a>,
            <a href="http://ipython.org/notebook.html" target="_blank">Python Notebook</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>, And
            <a href="/pages/this-blog-is-powered-by/index.html" target="_blank">Other Things</a>.
            <p>
            <a href="http://opensource.org/">
                <img src="/images/logos/open_source_logo.png" alt="Open Source Logo" title="The Open Source Initiative (OSI) is a non-profit corporation with global scope formed to educate about and advocate for the benefits of open source, and to build bridges among different constituencies in the open source community. The OSI maintains the Open Source Definition and the list of Open Source Initiative-approved licenses." height="40px" width="40px">
            </a>
            <a href="http://www.oshwa.org/">
                <img src="/images/logos/open-soruce-hardware-logo-800-px.png" alt="Open Source Hardware Logo" title="The Open Source Hardware Association aims to be the voice of the open hardware community, ensuring that technological knowledge is accessible to everyone, and encouraging the collaborative development of technology that serves education, environmental sustainability, and human welfare." height="40px" width="40px">
            </a>
            <small>
                All my work on this blog is
                <a href="http://opensource.org/licenses/MIT/" target="_blank">MIT Licensed, open, and free</a>,
                except where indicated otherwise.
            </small>
            </p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://code.jquery.com/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../../../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../../../theme/js/respond.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = '../../../../../theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'jeffskinnerbox',
                count: 5,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="../../../../../theme/js/github.js" type="text/javascript"></script>
</body>
</html>